CREATE DATABASE TravelAgencyDB;
GO
USE TravelAgencyDB;
GO

CREATE TABLE Trips (
    TripId INT IDENTITY PRIMARY KEY,
    Destination NVARCHAR(100) NOT NULL,
    Country NVARCHAR(100) NOT NULL,
    StartDate DATE NOT NULL,
    EndDate DATE NOT NULL,
    Price DECIMAL(10,2) NOT NULL,
    AvailableRooms INT NOT NULL,
    Category NVARCHAR(50),
    MinAge INT,
    Description NVARCHAR(MAX),
    ImagePath Nvarchar(MAX)
);

CREATE TABLE Users (
    UserId INT IDENTITY PRIMARY KEY,
    FullName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(100) NOT NULL UNIQUE,
    PasswordHash NVARCHAR(255) NOT NULL,
    Role NVARCHAR(20) NOT NULL -- 'Admin' or 'User'
);
CREATE TABLE Bookings (
    BookingId INT IDENTITY PRIMARY KEY,
    UserId INT NOT NULL,
    TripId INT NOT NULL,
    BookingDate DATETIME NOT NULL DEFAULT GETDATE(),
    Status NVARCHAR(20) NOT NULL, -- 'Active', 'Cancelled'
    
    CONSTRAINT FK_Booking_User FOREIGN KEY (UserId) REFERENCES Users(UserId),
    CONSTRAINT FK_Booking_Trip FOREIGN KEY (TripId) REFERENCES Trips(TripId)
);
CREATE TABLE WaitingList (
    WaitingId INT IDENTITY PRIMARY KEY,
    TripId INT NOT NULL,
    UserId INT NOT NULL,
    JoinDate DATETIME NOT NULL DEFAULT GETDATE(),

    CONSTRAINT FK_Waiting_Trip FOREIGN KEY (TripId) REFERENCES Trips(TripId),
    CONSTRAINT FK_Waiting_User FOREIGN KEY (UserId) REFERENCES Users(UserId),
    CONSTRAINT UQ_Wait UNIQUE (TripId, UserId)
);

CREATE TABLE Payments (
    PaymentId INT IDENTITY PRIMARY KEY,
    BookingId INT NOT NULL,
    Amount DECIMAL(10,2) NOT NULL,
    PaymentDate DATETIME NOT NULL DEFAULT GETDATE(),
    Status NVARCHAR(20) NOT NULL, -- 'Success', 'Failed'

    CONSTRAINT FK_Payment_Booking 
        FOREIGN KEY (BookingId) REFERENCES Bookings(BookingId)
);

ALTER TABLE Bookings
ADD IsPaid BIT NOT NULL DEFAULT 0,
    PaidAt DATETIME2 NULL;

ALTER TABLE Trips
ADD OldPrice DECIMAL(10,2) NULL,
DiscountEndDate DATETIME NULL;

ALTER TABLE Users 
ADD Status NVARCHAR(20) NOT NULL
Default 'Active';

CREATE TABLE Reviews (
    ReviewId INT IDENTITY(1,1) PRIMARY KEY,
    TripId INT NOT NULL,
    UserId INT NOT NULL,
    Rating INT CHECK (Rating BETWEEN 1 AND 5),
    Comment NVARCHAR(500),
    CreatedAt DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (TripId) REFERENCES Trips(TripId),
    FOREIGN KEY (UserId) REFERENCES Users(UserId)
);

CREATE TABLE TripImages (
    ImageId INT IDENTITY(1,1) PRIMARY KEY,
    TripId INT NOT NULL,
    ImagePath NVARCHAR(500) NOT NULL,
    FOREIGN KEY (TripId) REFERENCES Trips(TripId)
);

CREATE TABLE PasswordResets (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Email NVARCHAR(200) NOT NULL,
    Token NVARCHAR(200) NOT NULL,
    ExpireAt DATETIME NOT NULL
);
ALTER TABLE WaitingList
ADD NotifiedAt DATETIME NULL,
    ExpirationAt DATETIME NULL;
CREATE TABLE SiteReviews (
    ReviewId INT IDENTITY PRIMARY KEY,
    UserId INT NOT NULL,
    Rating INT CHECK (Rating BETWEEN 1 AND 5),
    Comment NVARCHAR(500),
    CreatedAt DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (UserId) REFERENCES Users(UserId)
);

ALTER TABLE Trips
ADD CancellationDays INT NOT NULL CONSTRAINT DF_Trips_CancellationDays DEFAULT 0;
ALTER TABLE Bookings
ADD Quantity INT NOT NULL Default 1;
ALTER TABLE Trips
ADD Quantity INT NOT NULL DEFAULT 1;
-- Add column if it doesn't exist
IF NOT EXISTS (
    SELECT 1
    FROM sys.columns
    WHERE Name = N'GroupMinAge'
      AND Object_ID = Object_ID(N'dbo.Bookings')
)
BEGIN
    ALTER TABLE dbo.Bookings
    ADD GroupMinAge INT NULL;
END
GO

-- Add a CHECK constraint to enforce 0..120 when value is present
IF NOT EXISTS (
    SELECT 1
    FROM sys.check_constraints
    WHERE name = N'CK_Bookings_GroupMinAge_Range'
)
BEGIN
    ALTER TABLE dbo.Bookings WITH CHECK
    ADD CONSTRAINT CK_Bookings_GroupMinAge_Range
    CHECK (GroupMinAge IS NULL OR (GroupMinAge BETWEEN 0 AND 120));
    ALTER TABLE dbo.Bookings CHECK CONSTRAINT CK_Bookings_GroupMinAge_Range;
END
GO

IF COL_LENGTH('dbo.Trips', 'PackageName') IS NULL
BEGIN
    ALTER TABLE dbo.Trips
    ADD PackageName NVARCHAR(200) NOT NULL
        CONSTRAINT DF_Trips_PackageName DEFAULT '';
END
GO


UPDATE dbo.Trips
SET PackageName =
    LTRIM(RTRIM(
        CONCAT(
            ISNULL(Destination, ''),
            CASE WHEN ISNULL(Category,'') <> '' THEN CONCAT(' ', Category) ELSE '' END,
            ' Package'
        )
    ))
WHERE (PackageName IS NULL OR LTRIM(RTRIM(PackageName)) = '');
GO

IF COL_LENGTH('dbo.Trips', 'IsHidden') IS NULL
BEGIN
    ALTER TABLE dbo.Trips
    ADD IsHidden BIT NOT NULL
        CONSTRAINT DF_Trips_IsHidden DEFAULT 0;
END
GO
