@{
    var publishableKey = ViewBag.StripePublishableKey as string;
    var bookingId = (int)ViewBag.BookingId;
}

<div class="container py-4" style="max-width:520px;">
    <h2 class="mb-3">Pay for booking #@bookingId</h2>

    @if (string.IsNullOrWhiteSpace(publishableKey) || publishableKey.Contains("REPLACE_ME", StringComparison.OrdinalIgnoreCase))
    {
        <div class="alert alert-warning">
            Stripe is not configured. Set <code>Stripe:PublishableKey</code> and <code>Stripe:SecretKey</code> in <code>appsettings.json</code>.
        </div>
    }

    <div id="payError" class="alert alert-danger d-none"></div>
    <div id="paySuccess" class="alert alert-success d-none">Payment successful. Redirecting…</div>

    <form id="payment-form">
        <div class="mb-3">
            <label class="form-label">Card details</label>
            <div id="payment-element" class="form-control" style="padding: 12px;"></div>
        </div>

        <button id="submit" class="btn btn-primary w-100" type="submit" disabled>
            Pay now
        </button>

        <div class="text-muted mt-2" style="font-size:0.85rem;">
            Test payments only (localhost). Use Stripe test cards.
        </div>
    </form>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
(function(){
    const publishableKey = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(publishableKey ?? ""));
    const bookingId = @bookingId;

    const errBox = document.getElementById('payError');
    const okBox  = document.getElementById('paySuccess');
    const submitBtn = document.getElementById('submit');

    function showError(msg){
        errBox.textContent = msg || 'Payment failed.';
        errBox.classList.remove('d-none');
        okBox.classList.add('d-none');
    }

    function clearError(){
        errBox.classList.add('d-none');
        errBox.textContent = '';
    }

    if(!publishableKey || publishableKey.toLowerCase().includes('replace_me')){
        showError('Stripe keys are not configured.');
        return;
    }

    const stripe = Stripe(publishableKey);

    // 1) Create PaymentIntent
    fetch('/Payment/CreateIntent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'bookingId=' + encodeURIComponent(bookingId)
    })
    .then(async (r) => {
        const data = await r.json().catch(() => ({}));
        if(!r.ok) throw new Error(data.error || 'Failed to start payment.');
        return data;
    })
    .then(async (data) => {
        clearError();

        const elements = stripe.elements({ clientSecret: data.clientSecret });
        const paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');

        submitBtn.disabled = false;

        // 2) Confirm on submit
        document.getElementById('payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;

            const { error, paymentIntent } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    // no redirect
                },
                redirect: 'if_required'
            });

            if (error) {
                showError(error.message);
                submitBtn.disabled = false;
                return;
            }

            if (!paymentIntent || paymentIntent.status !== 'succeeded') {
                showError('Payment not completed.');
                submitBtn.disabled = false;
                return;
            }

            // 3) Notify server to mark booking paid
            const finalize = await fetch('/Payment/Confirm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'bookingId=' + encodeURIComponent(bookingId) + '&paymentIntentId=' + encodeURIComponent(paymentIntent.id)
            });
            const finalizeData = await finalize.json().catch(() => ({}));

            if (!finalize.ok) {
                showError(finalizeData.error || 'Could not finalize payment.');
                submitBtn.disabled = false;
                return;
            }

            okBox.classList.remove('d-none');
            clearError();
            setTimeout(() => window.location.href = '/Booking/MyBookings', 700);
        });
    })
    .catch((e) => {
        showError(e.message);
        submitBtn.disabled = true;
    });
})();
</script>