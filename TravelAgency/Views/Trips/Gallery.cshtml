@model List<TravelAgency.ViewModel.TripGalleryItemVM>
@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = "Trip Gallery";
    ViewData["BodyClass"] = "";

    var discountedOnly = string.Equals(Context.Request.Query["discountedOnly"], "true", StringComparison.OrdinalIgnoreCase)
                      || string.Equals(Context.Request.Query["discountedOnly"], "on", StringComparison.OrdinalIgnoreCase);

    var selectedCategory = Context.Request.Query["category"].ToString();
    var selectedSort = Context.Request.Query["sort"].ToString();
}

<section class="ta-section ta-gallery">
    <div class="container">

        <div class="ta-gallery-header-card mb-4 text-center">
            <p class="section-subtitle mb-2">Discover</p>
            <h2 class="h2 section-title mb-2">Trip Gallery</h2>
            <p class="section-text mb-0">Browse our travel packages and book your next adventure.</p>
        </div>

        <!-- ===== TEMP MESSAGES ===== -->
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success text-center shadow-sm">
                <i class="bi bi-check-circle me-1"></i>@TempData["Success"]
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger text-center shadow-sm">
                <i class="bi bi-exclamation-triangle me-1"></i>@TempData["Error"]
            </div>
        }

        <div class="ta-gallery-hero mb-4">
            <div id="heroCarousel" class="carousel slide hero-carousel" data-bs-ride="carousel" data-bs-interval="3500">

                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="3" aria-label="Slide 4"></button>
                </div>

                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="/images/trips/hero-paris.jpg" alt="Paris">
                    </div>
                    <div class="carousel-item">
                        <img src="/images/trips/hero-rome.jpg" alt="Rome">
                    </div>
                    <div class="carousel-item">
                        <img src="/images/trips/hero-tokyo.jpg" alt="Tokyo">
                    </div>
                    <div class="carousel-item">
                        <img src="/images/trips/hero-newyork.jpg" alt="Dubai">
                    </div>
                </div>

                <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>

                <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

        <!-- FILTERS -->
        <form method="get" class="ta-filter-bar ta-filter-card mb-4">
            <div class="ta-filter-grid">

                <div class="ta-filter-field">
                    <label class="form-label ta-filter-label" for="taSearch">Search</label>
                    <div class="input-group input-group-sm ta-filter-input">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input id="taSearch" name="search" type="search"
                               class="form-control"
                               placeholder="Destination or country..."
                               value="@Context.Request.Query["search"]" />
                    </div>
                </div>

                <div class="ta-filter-field">
                    <label class="form-label ta-filter-label" for="taMin">Min Price</label>
                    <div class="input-group input-group-sm ta-filter-input">
                        <span class="input-group-text">‚Ç™</span>
                        <input id="taMin" name="minPrice" type="number" step="0.01"
                               class="form-control"
                               placeholder="Min"
                               value="@Context.Request.Query["minPrice"]" />
                    </div>
                </div>

                <div class="ta-filter-field">
                    <label class="form-label ta-filter-label" for="taMax">Max Price</label>
                    <div class="input-group input-group-sm ta-filter-input">
                        <span class="input-group-text">‚Ç™</span>
                        <input id="taMax" name="maxPrice" type="number" step="0.01"
                               class="form-control"
                               placeholder="Max"
                               value="@Context.Request.Query["maxPrice"]" />
                    </div>
                </div>

                <div class="ta-filter-field">
                    <label class="form-label ta-filter-label" for="taCategory">Category</label>
                    <select id="taCategory" name="category" class="form-select form-select-sm ta-filter-select">
                        <option value="" selected="@(string.IsNullOrEmpty(selectedCategory))">All categories</option>
                        <option value="Family" selected="@(selectedCategory == "Family")">Family</option>
                        <option value="Honeymoon" selected="@(selectedCategory == "Honeymoon")">Honeymoon</option>
                        <option value="Adventure" selected="@(selectedCategory == "Adventure")">Adventure</option>
                        <option value="Cruise" selected="@(selectedCategory == "Cruise")">Cruise</option>
                        <option value="Luxury" selected="@(selectedCategory == "Luxury")">Luxury</option>
                    </select>
                </div>

                <div class="ta-filter-field">
                    <label class="form-label ta-filter-label" for="taSort">Sort</label>
                    <select id="taSort" name="sort" class="form-select form-select-sm ta-filter-select">
                        <option value="" selected="@(string.IsNullOrEmpty(selectedSort))">Recommended</option>
                        <option value="price_asc" selected="@(selectedSort == "price_asc")">Price ‚Üë</option>
                        <option value="price_desc" selected="@(selectedSort == "price_desc")">Price ‚Üì</option>
                        <option value="date" selected="@(selectedSort == "date")">Date</option>
                        <option value="popular" selected="@(selectedSort == "popular")">Most Popular</option>
                    </select>
                </div>

                <div class="ta-filter-field ta-filter-check">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="discountedOnly" name="discountedOnly" value="true" @(discountedOnly ? "checked" : "") />
                        <label class="form-check-label" for="discountedOnly">Discounted only</label>
                    </div>
                </div>

                <div class="ta-filter-actions">
                    <button class="btn btn-primary btn-sm" type="submit">Apply</button>
                    <a class="btn btn-outline-primary btn-sm" href="/Trips/Gallery">Clear</a>
                </div>

            </div>
        </form>

        @if (!Model.Any())
        {
            <div class="alert alert-warning text-center">No trips found.</div>
        }

        <!-- CARDS -->
        <div class="row g-4">
            @foreach (var item in Model)
            {
                var t = item.Trip;
                var title = !string.IsNullOrWhiteSpace(t.PackageName) ? t.PackageName : $"{t.Destination}, {t.Country}";

                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="trip-card h-100 shadow-sm rounded-3">
                        <a href="/Trips/Details/@t.TripId" class="text-decoration-none">
                            @if (!string.IsNullOrEmpty(t.ImagePath))
                            {
                                <img src="@t.ImagePath" alt="@title" />
                            }
                            else
                            {
                                <img src="/images/default-trip.jpg" alt="No image" />
                            }
                        </a>

                        <div class="trip-info p-3">
                            <h5 class="package-name">@title</h5>

                            <span class="badge mb-2">@t.Category</span>

                            <div class="small text-muted mb-1">
                                üìç @t.Destination, @t.Country
                            </div>

                            <div class="small text-muted mb-1">
                                üìÖ @t.StartDate.ToString("dd/MM/yyyy") ‚Äì @t.EndDate.ToString("dd/MM/yyyy")
                            </div>

                            @{
                                bool onSale = t.OldPrice != null && t.DiscountEndDate != null && t.DiscountEndDate > DateTime.Now;
                            }

                            <div class="small mb-1">
                                <strong>Price per room:</strong>
                                @if (onSale)
                                {
                                    <span class="text-muted text-decoration-line-through">‚Ç™@t.OldPrice</span>
                                    <span class="text-danger fw-bold ms-1">‚Ç™@t.Price</span>
                                }
                                else
                                {
                                    <span class="price-highlight">‚Ç™@t.Price</span>
                                }
                            </div>

                            <div class="small">
                                <strong>Rooms:</strong> @t.AvailableRooms
                            </div>

                            @if (item.WaitingCount > 0)
                            {
                                <div class="mt-1">
                                    <span class="badge bg-warning text-dark">@item.WaitingCount waiting</span>
                                </div>
                            }

                            @if (t.MinAge.HasValue && t.MinAge.Value > 0)
                            {
                                <span class="badge bg-warning text-dark ms-2">
                                    Min age: @t.MinAge
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-success ms-2">
                                    All ages
                                </span>
                            }
                        </div>

                        <!-- ACTIONS -->
                        <div class="card-footer text-center py-3">
                             @if (t.AvailableRooms > 0)
                             {
                                 if (item.IsBookedByMe)
                                 {
                                     <button class="btn btn-success btn-sm w-75" disabled>Booked</button>
                                     <a href="/Booking/MyBookings" class="btn btn-outline-primary btn-sm mt-2 w-75">My Bookings</a>
                                 }
                                 else if (item.WaitingCount == 0 || item.IsMyTurn)
                                 {
                                    <button type="button" class="btn btn-primary btn-sm w-75 book-btn"
                                            data-tripid="@t.TripId" data-available="@t.AvailableRooms" data-minage="@(t.MinAge ?? 0)">
                                        Book Now
                                    </button>
                                 }
                                 else
                                 {
                                     <span class="text-warning small">
                                         Waiting list active
                                     </span>
                                 }
                             }
                             else
                             {
                                 <span class="text-danger small">
                                     Fully booked
                                 </span>
                             }

                             @if (Context.Session.GetInt32("UserId") != null)
                             {
                                 if (item.IAmInWaitingList)
                                 {
                                     <div class="mt-2 text-muted small">
                                         Position:
                                         <strong>@item.MyPosition</strong>

                                         <form method="post"
                                               action="/WaitingList/Leave"
                                               class="d-inline ms-1">
                                             <input type="hidden"
                                                    name="tripId"
                                                    value="@t.TripId" />
                                             <button class="btn btn-outline-danger btn-sm py-0 px-2">
                                                 Leave
                                             </button>
                                         </form>
                                     </div>
                                 }
                                 else if (!item.IsBookedByMe && (t.AvailableRooms <= 0 || item.WaitingCount > 0))
                                 {
                                     <form method="post"
                                           action="/WaitingList/Join"
                                           class="mt-2">
                                         <input type="hidden"
                                                name="tripId"
                                                value="@t.TripId" />
                                         <button class="btn btn-outline-secondary btn-sm w-75">
                                             Join Waiting List
                                         </button>
                                     </form>
                                 }
                             }
                         </div>
                     </div>
                 </div>
             }
         </div>

        <!-- ======== WHAT USERS THINK SECTION ======== -->
        <hr class="my-5" />
        <section id="site-reviews" class="mb-5 ta-reviews">
            <h3 class="text-center fw-bold text-primary mb-4">What users think about our service</h3>

            @if (Context.Session.GetInt32("UserId") != null)
            {
                <div class="mx-auto mb-4" style="max-width:520px;">
                    <form id="siteReviewForm">
                        <div class="mb-2">
                            <label class="form-label fw-semibold">Rating (1‚Äì5)</label>
                            <input class="form-control" name="rating" type="number" min="1" max="5" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Comment</label>
                            <textarea class="form-control" name="comment" maxlength="500" placeholder="Write your feedback about the website..."></textarea>
                        </div>
                        <button class="btn btn-primary w-100" type="submit">Submit Feedback</button>
                    </form>
                </div>
            }
            else
            {
                <p class="text-center">
                    <a class="btn btn-outline-primary" href="/Account/Login">Login to leave feedback</a>
                </p>
            }

            <div id="siteReviewList" class="row justify-content-center"></div>
        </section>

    </div>
 </section>

<!-- BOOK MODAL -->
<div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bookModalLabel">Book Rooms</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="get" action="/Booking/BookNow" id="bookForm">
        <div class="modal-body">
          <input type="hidden" name="id" id="modalTripId" />

          <div class="mb-2">
            <label class="form-label">How many rooms would you like?</label>
            <input type="number" name="qty" id="modalQty" class="form-control" value="1" min="1" />
            <div class="form-text" id="modalAvailableText"></div>
          </div>
          <div class="mb-2">
            <label class="form-label">Minimum age of participants</label>
            <input type="number" name="groupminAge" id="modalMinAge" class="form-control" value="0" min="0" />
            <div class="form-text" id="modalMinAgeHint"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Confirm</button>
        </div>
      </form>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        (function(){
            var bookModalEl = document.getElementById('bookModal');
            if(!bookModalEl) return;
            var modal = new bootstrap.Modal(bookModalEl);

            document.querySelectorAll('.book-btn').forEach(function(btn){
                btn.addEventListener('click', function(){
                    var tripId = btn.getAttribute('data-tripid');
                    var available = parseInt(btn.getAttribute('data-available') || '0', 10);
                    var tripMinAge = parseInt(btn.getAttribute('data-minage') || '0', 10);
                    document.getElementById('modalTripId').value = tripId;
                    var qty = document.getElementById('modalQty');
                    qty.value = 1;
                    qty.min = 1;
                    qty.max = available;
                    document.getElementById('modalAvailableText').textContent = available + ' rooms available.';
                    var minAgeInput = document.getElementById('modalMinAge');
                    minAgeInput.value = tripMinAge > 0 ? tripMinAge : 0;
                    minAgeInput.min = tripMinAge > 0 ? tripMinAge : 0;
                    document.getElementById('modalMinAgeHint').textContent = tripMinAge > 0 ? 'This trip requires minimum age of ' + tripMinAge + ' years.' : 'No minimum age restriction for this trip.';
                    modal.show();
                });
            });

            // simple client-side validation before submit
            document.getElementById('bookForm').addEventListener('submit', function(e){
                var qty = parseInt(document.getElementById('modalQty').value || '1', 10);
                var max = parseInt(document.getElementById('modalQty').max || '1', 10);
                var providedMinAge = parseInt(document.getElementById('modalMinAge').value || '0', 10);
                var tripMinAge = parseInt(document.getElementById('modalMinAge').min || '0', 10); // not authoritative
                if(qty < 1) { e.preventDefault(); alert('Quantity must be at least 1'); return; }
                if(qty > max) { e.preventDefault(); alert('Requested quantity exceeds availability'); return; }
                // server will enforce trip minAge, but do a quick client-side hint
                var hint = document.getElementById('modalMinAgeHint').textContent || '';
                if (hint.indexOf('requires minimum age') !== -1) {
                    var required = parseInt(hint.replace(/[^0-9]/g,'')) || 0;
                    if (providedMinAge < required) { e.preventDefault(); alert('Minimum age for this trip is ' + required + '. Please enter a valid minimum age.'); return; }
                }
            });
        })();
    </script>

    <script>
        function loadSiteReviews() {
            fetch('/SiteReviews/List')
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('siteReviewList');
                    list.innerHTML = '';

                    if (data.length === 0) {
                        list.innerHTML = '<p class="text-center text-muted">No feedback yet.</p>';
                        return;
                    }

                    const isAdmin = '@Context.Session.GetString("Role")' === 'Admin';
                    const currentUserId = @((Context.Session.GetInt32("UserId") ?? 0));

                    data.forEach(r => {
                        const stars = '‚òÖ'.repeat(r.rating) + '‚òÜ'.repeat(5 - r.rating);
                        const canDelete = isAdmin || (currentUserId !== 0 && r.userId === currentUserId);

                        const div = document.createElement('div');
                        div.className = 'col-md-5 col-lg-4 mb-3';
                        div.innerHTML = `
                            <div class="card shadow-sm border-0">
                                <div class="card-body position-relative">
                                    ${canDelete ? `
                                        <button class="btn btn-sm btn-outline-danger"
                                                style="position:absolute; top:12px; right:12px;"
                                                onclick="deleteSiteReview(${r.reviewId})">
                                            Delete
                                        </button>` : ''}

                                    <div class="text-warning mb-1" style="font-size:1.1rem;">${stars}</div>
                                    ${r.comment ? `<p>${r.comment}</p>` : ''}
                                    <small class="text-muted">‚Äî ${r.fullName} (${r.createdAt})</small>
                                </div>
                            </div>`;
                        list.appendChild(div);
                    });
                });
        }

        function deleteSiteReview(id) {
            if (!confirm("Are you sure you want to delete this review?")) return;

            fetch('/SiteReviews/Delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'id=' + encodeURIComponent(id)
            })
                .then(res => {
                    if (!res.ok) throw new Error();
                    loadSiteReviews();
                })
                .catch(() => alert('Failed to delete review.'));
        }

        loadSiteReviews();

        document.getElementById('siteReviewForm')?.addEventListener('submit', e => {
            e.preventDefault();
            const form = e.target;
            const data = new URLSearchParams(new FormData(form));

            fetch('/SiteReviews/Add', {
                method: 'POST',
                body: data
            })
                .then(res => {
                    if (!res.ok) throw new Error();
                    return res.json();
                })
                .then(() => {
                    form.reset();
                    loadSiteReviews();
                })
                .catch(() => alert('Failed to send feedback.'));
        });
    </script>
}
