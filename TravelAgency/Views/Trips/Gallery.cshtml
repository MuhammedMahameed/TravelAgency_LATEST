@model List<TravelAgency.ViewModel.TripGalleryItemVM>
@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = "Trip Gallery";
    ViewData["BodyClass"] = "login-light";
}

<div class="login-page container-fluid">

    <div class="container py-4">

        <h1 class="fw-bold text-center mb-2 login-title">üåç Trip Gallery</h1>
        <p class="text-center text-muted mb-4">
            Browse our travel packages and book your next adventure
        </p>

        <!-- FILTERS -->
        <form method="get" class="row g-2 mb-4 justify-content-center">

            <div class="col-md-3 col-sm-6">
                <input name="search"
                       class="form-control form-control-sm"
                       placeholder="Search destination..."
                       value="@Context.Request.Query["search"]" />
            </div>

            <div class="col-md-2 col-sm-3">
                <input name="minPrice"
                       type="number"
                       step="0.01"
                       class="form-control form-control-sm"
                       placeholder="Min ‚Ç™"
                       value="@Context.Request.Query["minPrice"]" />
            </div>

            <div class="col-md-2 col-sm-3">
                <input name="maxPrice"
                       type="number"
                       step="0.01"
                       class="form-control form-control-sm"
                       placeholder="Max ‚Ç™"
                       value="@Context.Request.Query["maxPrice"]" />
            </div>

            <div class="col-md-2 col-sm-4">
                <select name="category" class="form-select form-select-sm">
                    <option value="">All categories</option>
                    <option>Family</option>
                    <option>Honeymoon</option>
                    <option>Adventure</option>
                    <option>Cruise</option>
                    <option>Luxury</option>
                </select>
            </div>

            <div class="col-md-2 col-sm-4">
                <select name="sort" class="form-select form-select-sm">
                    <option value="">Sort</option>
                    <option value="price_asc">Price ‚Üë</option>
                    <option value="price_desc">Price ‚Üì</option>
                    <option value="date">Date</option>
                    <option value="popular">Most Popular</option>
                </select>
            </div>

            <div class="col-md-1 col-sm-4">
                <button class="btn btn-primary btn-sm w-100">
                    Apply
                </button>
            </div>
        </form>

        @if (!Model.Any())
        {
            <div class="alert alert-warning text-center">
                No trips found.
            </div>
        }

        <!-- CARDS -->
        <div class="row g-3">

            @foreach (var item in Model)
            {
                var t = item.Trip;

                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card h-100 shadow-sm border-0 rounded-3">

                        <!-- IMAGE -->
                        <a href="/Trips/Details/@t.TripId" class="text-decoration-none">
                            @if (!string.IsNullOrEmpty(t.ImagePath))
                            {
                                <img src="@t.ImagePath"
                                     class="card-img-top"
                                     style="height:150px; object-fit:cover;" />
                            }
                            else
                            {
                                <div style="height:150px; background:#f1f3f5;
                                                    display:flex; align-items:center; justify-content:center;">
                                    <span class="text-muted small">No image</span>
                                </div>
                            }
                        </a>

                        <div class="card-body py-2 px-3">

                            <h6 class="fw-bold mb-1">
                                @t.Destination, @t.Country
                            </h6>

                            <span class="badge bg-light text-dark border mb-1">
                                @t.Category
                            </span>

                            <div class="small text-muted mb-1">
                                üìÖ @t.StartDate.ToShortDateString() ‚Äì @t.EndDate.ToShortDateString()
                            </div>

                            @{
                                bool onSale =
                                t.OldPrice != null &&
                                t.DiscountEndDate != null &&
                                t.DiscountEndDate > DateTime.Now;
                            }

                            <div class="small mb-1">
                                <strong>Price:</strong>
                                @if (onSale)
                                {
                                    <span class="text-muted text-decoration-line-through">
                                        ‚Ç™@t.OldPrice
                                    </span>
                                    <span class="text-danger fw-bold ms-1">
                                        ‚Ç™@t.Price
                                    </span>
                                }
                                else
                                {
                                    <span class="fw-semibold">‚Ç™@t.Price</span>
                                }
                            </div>

                            <div class="small">
                                <strong>Rooms:</strong> @t.AvailableRooms
                            </div>

                            @if (item.WaitingCount > 0)
                            {
                                <span class="badge bg-warning text-dark mt-1">
                                    @item.WaitingCount waiting
                                </span>
                            }
                        </div>

                        <!-- ACTIONS -->
                        <div class="card-footer bg-white border-0 px-3 pb-3 pt-2">

                            @if (t.AvailableRooms > 0)
                            {
                                if (item.WaitingCount == 0 || item.IsMyTurn)
                                {
                                    <a href="/Booking/Start/@t.TripId"
                                       class="btn btn-primary btn-sm w-100">
                                        Book
                                    </a>
                                }
                                else
                                {
                                    <span class="text-warning small">
                                        Waiting list active
                                    </span>
                                }
                            }
                            else
                            {
                                <span class="text-danger small">
                                    Fully booked
                                </span>
                            }

                            @if (Context.Session.GetInt32("UserId") != null)
                            {
                                if (item.IAmInWaitingList)
                                {
                                    <div class="mt-1 text-muted small">
                                        Position:
                                        <strong>@item.MyPosition</strong>

                                        <form method="post"
                                              action="/WaitingList/Leave"
                                              class="d-inline ms-1">
                                            <input type="hidden"
                                                   name="tripId"
                                                   value="@t.TripId" />
                                            <button class="btn btn-outline-danger btn-sm py-0 px-2">
                                                Leave
                                            </button>
                                        </form>
                                    </div>
                                }
                                else if (t.AvailableRooms <= 0 || item.WaitingCount > 0)
                                {
                                    <form method="post"
                                          action="/WaitingList/Join"
                                          class="mt-1">
                                        <input type="hidden"
                                               name="tripId"
                                               value="@t.TripId" />
                                        <button class="btn btn-outline-secondary btn-sm w-100">
                                            Join Waiting List
                                        </button>
                                    </form>
                                }
                            }
                        </div>

                    </div>
                </div>
            }

        </div>

    </div>

</div>
