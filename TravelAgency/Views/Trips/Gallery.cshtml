@model List<TravelAgency.ViewModel.TripGalleryItemVM>
@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = "Trip Gallery";
    ViewData["BodyClass"] = "login-light";
}

<link rel="stylesheet" href="~/css/gallery.css" />

<div class="login-page container-fluid">
    <div class="container py-2" style="margin-top:-95px;">

        <div class="gallery-header">
            <h1>Trip Gallery</h1>
            <p>Browse our travel packages and book your next adventure</p>
        </div>

        <div class="hero-wrap">
            <div id="heroCarousel" class="carousel slide hero-carousel" data-bs-ride="carousel" data-bs-interval="3500">

                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="3" aria-label="Slide 4"></button>
                </div>

                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="/images/trips/hero-paris.jpg" alt="Paris">
                    </div>

                    <div class="carousel-item">
                        <img src="/images/trips/hero-rome.jpg" alt="Rome">
                    </div>

                    <div class="carousel-item">
                        <img src="/images/trips/hero-tokyo.jpg" alt="Tokyo">
                    </div>

                    <div class="carousel-item">
                        <img src="/images/trips/hero-newyork.jpg" alt="Dubai">
                    </div>
                </div>

                <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>

                <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>

            </div>
        </div>

        <!-- FILTERS -->
        <form method="get" class="row g-2 mb-4 justify-content-center">
            <div class="col-md-3 col-sm-6">
                <input name="search"
                       class="form-control form-control-sm"
                       placeholder="Search destination..."
                       value="@Context.Request.Query["search"]" />
            </div>

            <div class="col-md-2 col-sm-3">
                <input name="minPrice"
                       type="number"
                       step="0.01"
                       class="form-control form-control-sm"
                       placeholder="Min â‚ª"
                       value="@Context.Request.Query["minPrice"]" />
            </div>

            <div class="col-md-2 col-sm-3">
                <input name="maxPrice"
                       type="number"
                       step="0.01"
                       class="form-control form-control-sm"
                       placeholder="Max â‚ª"
                       value="@Context.Request.Query["maxPrice"]" />
            </div>

            <div class="col-md-2 col-sm-4">
                <select name="category" class="form-select form-select-sm">
                    <option value="">All categories</option>
                    <option>Family</option>
                    <option>Honeymoon</option>
                    <option>Adventure</option>
                    <option>Cruise</option>
                    <option>Luxury</option>
                </select>
            </div>

            <div class="col-md-2 col-sm-4">
                <select name="sort" class="form-select form-select-sm">
                    <option value="">Sort</option>
                    <option value="price_asc">Price â†‘</option>
                    <option value="price_desc">Price â†“</option>
                    <option value="date">Date</option>
                    <option value="popular">Most Popular</option>
                </select>
            </div>

            <div class="col-md-1 col-sm-4">
                <button class="btn btn-primary btn-sm w-100">
                    Apply
                </button>
            </div>
        </form>

        @if (!Model.Any())
        {
            <div class="alert alert-warning text-center">
                No trips found.
            </div>
        }

        <!-- CARDS -->
        <div class="row g-4">
            @foreach (var item in Model)
            {
                var t = item.Trip;

                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="trip-card h-100">
                        <a href="/Trips/Details/@t.TripId" class="text-decoration-none">
                            @if (!string.IsNullOrEmpty(t.ImagePath))
                            {
                                <img src="@t.ImagePath" alt="@t.Destination" />
                            }
                            else
                            {
                                <img src="/images/default-trip.jpg" alt="No image" />
                            }
                        </a>

                        <div class="trip-info p-3">
                            <span class="badge mb-2">@t.Category</span>
                            <h6>@t.Destination, @t.Country</h6>

                            <div class="small text-muted mb-1">
                                ðŸ“… @t.StartDate.ToString("dd/MM/yyyy") â€“ @t.EndDate.ToString("dd/MM/yyyy")
                            </div>

                            @{
                                bool onSale =
                                t.OldPrice != null &&
                                t.DiscountEndDate != null &&
                                t.DiscountEndDate > DateTime.Now;
                            }

                            <div class="small mb-1">
                                <strong>Price:</strong>
                                @if (onSale)
                                {
                                    <span class="text-muted text-decoration-line-through">
                                        â‚ª@t.OldPrice
                                    </span>
                                    <span class="text-danger fw-bold ms-1">
                                        â‚ª@t.Price
                                    </span>
                                }
                                else
                                {
                                    <span class="price-highlight">â‚ª@t.Price</span>
                                }
                            </div>

                            <div class="small">
                                <strong>Rooms:</strong> @t.AvailableRooms
                            </div>

                            @if (item.WaitingCount > 0)
                            {
                                <span class="badge bg-warning text-dark mt-1">
                                    @item.WaitingCount waiting
                                </span>
                            }
                        </div>

                        <!-- ACTIONS -->
                        <div class="card-footer text-center py-3">
                            @if (t.AvailableRooms > 0)
                            {
                                if (item.IsBookedByMe)
                                {
                                    <button class="btn btn-success btn-sm w-75" disabled>Booked</button>
                                    <a href="/Booking/MyBookings" class="btn btn-outline-primary btn-sm mt-2 w-75">My Bookings</a>
                                }
                                else if (item.WaitingCount == 0 || item.IsMyTurn)
                                {
                                    <a href="/Booking/Start/@t.TripId"
                                       class="btn btn-primary btn-sm w-75">
                                        Book Now
                                    </a>
                                }
                                else
                                {
                                    <span class="text-warning small">
                                        Waiting list active
                                    </span>
                                }
                            }
                            else
                            {
                                <span class="text-danger small">
                                    Fully booked
                                </span>
                            }

                            @if (Context.Session.GetInt32("UserId") != null)
                            {
                                if (item.IAmInWaitingList)
                                {
                                    <div class="mt-2 text-muted small">
                                        Position:
                                        <strong>@item.MyPosition</strong>

                                        <form method="post"
                                              action="/WaitingList/Leave"
                                              class="d-inline ms-1">
                                            <input type="hidden"
                                                   name="tripId"
                                                   value="@t.TripId" />
                                            <button class="btn btn-outline-danger btn-sm py-0 px-2">
                                                Leave
                                            </button>
                                        </form>
                                    </div>
                                }
                                else if (!item.IsBookedByMe && (t.AvailableRooms <= 0 || item.WaitingCount > 0))
                                {
                                    <form method="post"
                                          action="/WaitingList/Join"
                                          class="mt-2">
                                        <input type="hidden"
                                               name="tripId"
                                               value="@t.TripId" />
                                        <button class="btn btn-outline-secondary btn-sm w-75">
                                            Join Waiting List
                                        </button>
                                    </form>
                                }
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- ======== WHAT USERS THINK SECTION ======== -->
        <hr class="my-5" />
        <section id="site-reviews" class="mb-5">
            <h3 class="text-center fw-bold text-primary mb-4">What users think about our service</h3>

            @if (Context.Session.GetInt32("UserId") != null)
            {
                <div class="mx-auto mb-4" style="max-width:520px;">
                    <form id="siteReviewForm">
                        <div class="mb-2">
                            <label class="form-label fw-semibold">Rating (1â€“5)</label>
                            <input class="form-control" name="rating" type="number" min="1" max="5" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Comment</label>
                            <textarea class="form-control" name="comment" maxlength="500"
                                  placeholder="Write your feedback about the website..."></textarea>
                        </div>
                        <button class="btn btn-primary w-100" type="submit">Submit Feedback</button>
                    </form>
                </div>
            }
            else
            {
                <p class="text-center">
                    <a class="btn btn-outline-primary" href="/Account/Login">Login to leave feedback</a>
                </p>
            }

            <div id="siteReviewList" class="row justify-content-center"></div>
        </section>

        @section Scripts {
            <script>
                function loadSiteReviews() {
                    fetch('/SiteReviews/List')
                        .then(res => res.json())
                        .then(data => {
                            const list = document.getElementById('siteReviewList');
                            list.innerHTML = '';

                            if (data.length === 0) {
                                list.innerHTML = '<p class="text-center text-muted">No feedback yet.</p>';
                                return;
                            }

                            const isAdmin = '@Context.Session.GetString("Role")' === 'Admin';
                            const currentUserId = @((Context.Session.GetInt32("UserId") ?? 0));

                            data.forEach(r => {
                                const stars = 'â˜…'.repeat(r.rating) + 'â˜†'.repeat(5 - r.rating);
                                const canDelete = isAdmin || (currentUserId !== 0 && r.userId === currentUserId);

                                const div = document.createElement('div');
                                div.className = 'col-md-5 col-lg-4 mb-3';
                                div.innerHTML = `
                                    <div class="card shadow-sm border-0">
                                        <div class="card-body position-relative">
                                            ${canDelete ? `
                                                <button class="btn btn-sm btn-outline-danger"
                                                        style="position:absolute; top:12px; right:12px;"
                                                        onclick="deleteSiteReview(${r.reviewId})">
                                                    Delete
                                                </button>` : ''}

                                            <div class="text-warning mb-1" style="font-size:1.1rem;">${stars}</div>
                                            ${r.comment ? `<p>${r.comment}</p>` : ''}
                                            <small class="text-muted">â€” ${r.fullName} (${r.createdAt})</small>
                                        </div>
                                    </div>`;
                                list.appendChild(div);
                            });
                        });
                }

                function deleteSiteReview(id) {
                    if (!confirm("Are you sure you want to delete this review?")) return;

                    fetch('/SiteReviews/Delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'id=' + encodeURIComponent(id)
                    })
                        .then(res => {
                            if (!res.ok) throw new Error();
                            loadSiteReviews();
                        })
                        .catch(() => alert('Failed to delete review.'));
                }

                loadSiteReviews();

                document.getElementById('siteReviewForm')?.addEventListener('submit', e => {
                    e.preventDefault();
                    const form = e.target;
                    const data = new URLSearchParams(new FormData(form));

                    fetch('/SiteReviews/Add', {
                        method: 'POST',
                        body: data
                    })
                        .then(res => {
                            if (!res.ok) throw new Error();
                            return res.json();
                        })
                        .then(() => {
                            form.reset();
                            loadSiteReviews();
                        })
                        .catch(() => alert('Failed to send feedback.'));
                });
            </script>

        }
    </div>
</div>
