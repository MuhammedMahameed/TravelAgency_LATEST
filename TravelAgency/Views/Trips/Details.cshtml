@model TravelAgency.Models.Trip
@inject IConfiguration Configuration
@inject IHttpContextAccessor HttpContextAccessor
@using Microsoft.Data.SqlClient
@using Microsoft.AspNetCore.Http

<div class="container mt-4">

    <h2>@Model.Destination, @Model.Country</h2>

    @{
        var gallery = new List<string>();

        var connStrImgs = Configuration.GetConnectionString("DefaultConnection");
        using (var connImgs = new SqlConnection(connStrImgs))
        {
            connImgs.Open();
            var imgCmd = new SqlCommand("SELECT ImagePath FROM TripImages WHERE TripId = @tid", connImgs);
            imgCmd.Parameters.AddWithValue("@tid", Model.TripId);

            using var r = imgCmd.ExecuteReader();
            while (r.Read())
            {
                var p = r["ImagePath"]?.ToString();
                if (!string.IsNullOrWhiteSpace(p))
                    gallery.Add(p);
            }
        }
    }

    @* אם יש תמונה ראשית או תמונות גלריה -> מציגים carousel *@
    @if (!string.IsNullOrEmpty(Model.ImagePath) || gallery.Count > 0)
    {
        <div id="tripGallery" class="carousel slide mb-4" data-bs-ride="carousel">
            <div class="carousel-inner">

                @* תמונה ראשית תמיד ראשונה אם קיימת *@
                @if (!string.IsNullOrEmpty(Model.ImagePath))
                {
                    <div class="carousel-item active">
                        <img src="@Model.ImagePath"
                             class="d-block w-100 rounded"
                             style="max-height:400px; object-fit:cover;" />
                    </div>
                }

                @* אם אין תמונה ראשית אבל יש גלריה, הראשונה תהיה active *@
                @if (string.IsNullOrEmpty(Model.ImagePath) && gallery.Count > 0)
                {
                    <div class="carousel-item active">
                        <img src="@gallery[0]"
                             class="d-block w-100 rounded"
                             style="max-height:400px; object-fit:cover;" />
                    </div>

                    @for (int i = 1; i < gallery.Count; i++)
                    {
                        <div class="carousel-item">
                            <img src="@gallery[i]"
                                 class="d-block w-100 rounded"
                                 style="max-height:400px; object-fit:cover;" />
                        </div>
                    }
                }
                else
                {
                    @* יש תמונה ראשית -> כל תמונות הגלריה מתווספות כפריטים רגילים *@
                    @foreach (var img in gallery)
                    {
                        <div class="carousel-item">
                            <img src="@img"
                                 class="d-block w-100 rounded"
                                 style="max-height:400px; object-fit:cover;" />
                        </div>
                    }
                }
            </div>

            @* חיצים יופיעו רק אם יש יותר מתמונה אחת *@
            @if ((!string.IsNullOrEmpty(Model.ImagePath) && gallery.Count > 0) || (string.IsNullOrEmpty(Model.ImagePath) && gallery.Count > 1))
            {
                <button class="carousel-control-prev" type="button" data-bs-target="#tripGallery" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>

                <button class="carousel-control-next" type="button" data-bs-target="#tripGallery" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            }
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <p><strong>Category:</strong> @Model.Category</p>
            <p><strong>Start Date:</strong> @Model.StartDate.ToShortDateString()</p>
            <p><strong>End Date:</strong> @Model.EndDate.ToShortDateString()</p>
        </div>

        <div class="col-md-6">
            <p><strong>Price:</strong> ₪@Model.Price</p>
            <p><strong>Available Rooms:</strong> @Model.AvailableRooms</p>
        </div>
    </div>

    <hr />

    <p>@Model.Description</p>

    <div class="mt-3">
        @if (Model.AvailableRooms > 0)
        {
            <a href="/Booking/BookNow/@Model.TripId" class="btn btn-primary">
                Book Now
            </a>
        }
        else
        {
            <span class="text-danger">Fully booked</span>
        }

        <a href="/Trips/Gallery" class="btn btn-secondary ms-2">
            Back to Gallery
        </a>
    </div>

    <!-- =========================
         REVIEWS SECTION (ADDED)
         ========================= -->

    <hr />
    <h4 id="reviews" class="mt-4">User Reviews</h4>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    @{
        var reviews = new List<dynamic>();

        var connStr = Configuration.GetConnectionString("DefaultConnection");
        using (var conn = new SqlConnection(connStr))
        {
            conn.Open();
            using var cmd = new SqlCommand(@"
        SELECT r.ReviewId, r.Rating, r.Comment, r.CreatedAt, u.FullName
        FROM Reviews r
        JOIN Users u ON r.UserId = u.UserId
        WHERE r.TripId = @tid
        ORDER BY r.CreatedAt DESC
        ", conn);

            cmd.Parameters.AddWithValue("@tid", Model.TripId);

            using var reader = cmd.ExecuteReader();
            while (reader.Read())
            {
                reviews.Add(new
                {
                    ReviewId = Convert.ToInt32(reader["ReviewId"]),
                    FullName = reader["FullName"]?.ToString() ?? "",
                    Rating = Convert.ToInt32(reader["Rating"]),
                    Comment = reader["Comment"] == DBNull.Value ? "" : reader["Comment"]?.ToString() ?? "",
                    CreatedAt = Convert.ToDateTime(reader["CreatedAt"])
                });
            }
        }
    }

    @if (reviews.Count == 0)
    {
        <p class="text-muted">No reviews yet. Be the first to review this trip!</p>
    }
    else
    {
        foreach (var r in reviews)
        {
            <div class="review border rounded p-3 mb-3 shadow-sm bg-light">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <strong>@r.FullName</strong>

                    <div class="d-flex align-items-center gap-2">
                        <small class="text-muted">@r.CreatedAt.ToString("dd/MM/yyyy")</small>

                        @if (HttpContextAccessor.HttpContext?.Session.GetString("Role") == "Admin")
                        {
                            <form asp-controller="Reviews" asp-action="Delete" method="post" class="d-inline">
                                <input type="hidden" name="reviewId" value="@r.ReviewId" />
                                <input type="hidden" name="tripId" value="@Model.TripId" />
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                        }
                    </div>
                </div>

                <div class="text-warning" style="font-size: 1.1rem;">
                    @for (int i = 0; i < r.Rating; i++)
                    {
                        @:★
                    }
                    @for (int i = r.Rating; i < 5; i++)
                    {
                        @:☆
                    }
                </div>

                @if (!string.IsNullOrWhiteSpace((string)r.Comment))
                {
                    <p class="mb-0">@r.Comment</p>
                }
            </div>
        }
    }

    @if (HttpContextAccessor.HttpContext?.Session.GetInt32("UserId") != null)
    {
        <hr />
        <h5 class="mt-3">Add your review</h5>

        <form asp-controller="Reviews" asp-action="Add" method="post">
            <input type="hidden" name="tripId" value="@Model.TripId" />

            <div class="mb-2">
                <label class="form-label"><strong>Rating (1–5)</strong></label>
                <input type="number" name="rating" min="1" max="5" required class="form-control" />
            </div>

            <div class="mb-2">
                <label class="form-label"><strong>Comment</strong> (optional)</label>
                <textarea name="comment" class="form-control" rows="3" maxlength="500"></textarea>
            </div>

            <button class="btn btn-primary">Submit</button>
        </form>
    }
</div>
